{"version":3,"file":"main-e8f745b584c6de6.js","mappings":"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","sources":["webpack://clear_horizon/./@nextgis/packages/cache/src/Cache.ts","webpack://clear_horizon/./@nextgis/packages/cache/src/index.ts","webpack://clear_horizon/./@nextgis/packages/cancelable-promise/src/CancelError.ts","webpack://clear_horizon/./@nextgis/packages/cancelable-promise/src/PromiseControl.ts","webpack://clear_horizon/./@nextgis/packages/cancelable-promise/src/TimeoutError.ts","webpack://clear_horizon/./@nextgis/packages/cancelable-promise/src/CancelablePromise.ts","webpack://clear_horizon/./@nextgis/packages/cancelable-promise/src/index.ts"],"sourcesContent":["import { objectDeepEqual, objectRemoveEmpty, full } from '@nextgis/utils';\n\ntype CacheValue<T> = T;\ntype CacheMatchProps<T> = Record<keyof T, T[keyof T]>;\n\ninterface CacheItem<T = any, O = any> {\n  key: string;\n  value: CacheValue<T>;\n  props?: CacheMatchProps<O>;\n  /** @deprecated use {@link CacheItem.props} instead */\n  options?: CacheMatchProps<O>;\n}\n\nexport interface CacheOptions {\n  /**\n   * Cache Scope Separator\n   * @defaultValue 'default'\n   */\n  namespace?: string;\n}\n\n/**\n * @example\n * ```javascript\n * const cache1 = new Cache();\n * cache1.add('foo', 'value');\n *\n * const cache2 = new Cache();\n * cache2.match('foo'); // value\n *\n * const cache3 = new Cache({ namespace: 'foo' });\n * cache3.match('foo'); // undefined\n * ```\n *\n * @example\n * ```javascript\n * let COUNTER = 0;\n * const createPromise = () => new Promise((res) => {\n *   COUNTER++\n *   setTimeout(() => res('Ok'), 300)\n * });\n *\n * const cache = new Cache();\n * for (let i = 0; i < 10; i++) {\n *   cache.add('foo', createPromise).then((data) => {\n *     console.log(data); // 'Ok'\n *   });\n * }\n * console.log(COUNTER); // 1\n * ```\n */\nexport class Cache<\n  V = any,\n  O extends Record<string, unknown> = Record<string, unknown>,\n> {\n  private static instance: Record<\n    string,\n    Cache<unknown, Record<string, unknown>>\n  > = {};\n  private readonly cache: CacheItem<V, O>[] = [];\n\n  constructor(options: CacheOptions = {}) {\n    const namespace = options.namespace ?? 'default';\n    if (Cache.instance[namespace]) {\n      return Cache.instance[namespace] as Cache<V, O>;\n    }\n    Cache.instance[namespace] = this;\n    return this;\n  }\n\n  clean(): void {\n    this.cache.length = 0;\n  }\n\n  all(): CacheItem<V, O>[] {\n    return this.cache;\n  }\n\n  /**\n   * Caching only a non-empty value.\n   *\n   * Useful for get or create strategy\n   * @example\n   * ```javascript\n   * const cache = new Cache();\n   * const getItemFunc = () => fetch(url).then((data) => {\n   *  return data.json(); // undefined\n   * });\n   * const item = await cache.addFull('foo', getItemFunc);\n   * if (!item) {\n   *   await createItem(); // 'New item'\n   * }\n   *\n   * // somewhere else in the code\n   * const item = await cache.addFull('foo', getItemFunc).then((resp) => {\n   *   console.log(resp); // 'New item'\n   * })\n   *\n   * ```\n   */\n  addFull(\n    key: string,\n    valueToSet: CacheValue<V> | (() => CacheValue<V>),\n    props?: CacheMatchProps<O>,\n  ): CacheValue<V> {\n    return this.add(key, valueToSet, props, true);\n  }\n\n  add(\n    key: string,\n    valueToSet: CacheValue<V> | (() => CacheValue<V>),\n    props?: CacheMatchProps<O>,\n    onlyFull?: boolean,\n  ): CacheValue<V> {\n    const exist = this._find(key, props);\n    if (!exist) {\n      let value: CacheValue<V>;\n      if (valueToSet instanceof Function) {\n        value = valueToSet();\n      } else {\n        value = valueToSet;\n      }\n      const props_ =\n        props && JSON.parse(JSON.stringify(objectRemoveEmpty(props)));\n\n      const cacheItem: CacheItem<V, O> = {\n        key,\n        value,\n        props: props_,\n        // TODO: remove backward compatibility use only props\n        options: props_,\n      };\n      if (onlyFull && !full(value)) {\n        return value;\n      }\n      this.cache.push(cacheItem);\n      if (value instanceof Promise) {\n        value.catch((er) => {\n          this.delete(key, props);\n          throw er;\n        });\n        if (onlyFull) {\n          value.then((x) => {\n            if (!full(x)) {\n              this.delete(key, props);\n            }\n            return x;\n          });\n        }\n        return value;\n      }\n      return value;\n    } else {\n      return exist.value;\n    }\n  }\n\n  match(key: string, props?: CacheMatchProps<O>): CacheValue<V> | undefined {\n    const cacheRecord = this._find(key, props);\n\n    if (cacheRecord) {\n      return cacheRecord.value;\n    }\n  }\n\n  matchAll(key?: string, props?: CacheMatchProps<O>): CacheValue<V>[] {\n    if (key) {\n      return this.cache\n        .filter((x) => this._filter(x, key, props))\n        .map((x) => x.value);\n    }\n    return this.cache.map((x) => x.value);\n  }\n\n  delete(item: CacheItem): void;\n  delete(key: string, props?: CacheMatchProps<O>): void;\n  delete(keyOrItem: string | CacheItem, props?: CacheMatchProps<O>): void {\n    let exist: CacheItem[] = [];\n    if (typeof keyOrItem === 'string') {\n      exist = this.cache.filter((x) => this._filter(x, keyOrItem, props));\n    } else {\n      exist.push(keyOrItem);\n    }\n    for (const e of exist) {\n      const index = this.cache.indexOf(e);\n      this.cache.splice(index, 1);\n    }\n  }\n\n  private _find(\n    key: string,\n    props?: CacheMatchProps<O>,\n  ): CacheItem<V> | undefined {\n    return this.cache.find((x) => this._filter(x, key, props));\n  }\n\n  private _filter(\n    item: CacheItem,\n    key: string,\n    props?: CacheMatchProps<O>,\n  ): boolean {\n    if (item.key === key) {\n      if (props) {\n        // TODO: remove backward compatibility\n        const itemProps = item.props || item.options;\n        return objectDeepEqual(itemProps || {}, objectRemoveEmpty(props));\n      }\n      return true;\n    }\n    return false;\n  }\n}\n","/**\n * Caching for asynchronous functions\n *\n * @packageDocumentation\n * @module cache\n */\nimport { Cache } from './Cache';\n\nexport default Cache;\n","export class CancelError extends Error {\n  name = 'CancelError';\n\n  constructor() {\n    super();\n    Object.setPrototypeOf(this, CancelError.prototype);\n  }\n}\n","import CancelablePromise from '.';\n\nexport interface PromiseControlOptions {\n  onStart?: () => void;\n  onStop?: () => void;\n}\n\ntype Key = CancelablePromise | string | number | symbol;\n\nexport class PromiseControl {\n  private _promises: Map<Key, CancelablePromise> = new Map();\n\n  constructor(private options: PromiseControlOptions = {}) {}\n\n  get isLoaded(): boolean {\n    return this._promises.size > 0;\n  }\n\n  remove(promise: Key): void {\n    if (this._promises.has(promise)) {\n      this._promises.delete(promise);\n      this._onStop();\n    }\n  }\n\n  get(promise: Key): CancelablePromise | undefined {\n    return this._promises.get(promise);\n  }\n\n  add<T extends CancelablePromise = CancelablePromise>(\n    promise: T,\n    name?: string | number | symbol,\n  ): CancelablePromise<T> {\n    const key = name ? name : promise;\n    const exist = this._promises.get(key);\n    if (this.options.onStart && !this.isLoaded) {\n      this.options.onStart();\n    }\n    if (exist) {\n      return exist;\n    }\n    this._promises.set(key, promise);\n    promise.finally(() => {\n      this.remove(key);\n    });\n    return promise;\n  }\n\n  abort(): void {\n    if (this.isLoaded) {\n      this._promises.forEach((x) => {\n        if (x.cancel) {\n          x.cancel();\n        }\n      });\n      this._promises.clear();\n      this._onStop();\n    }\n  }\n\n  waitFunc<T>(func: () => any, name = ''): CancelablePromise<T> {\n    name = name || func.name;\n    const exist = this.get(name);\n    if (exist) {\n      return exist;\n    }\n    return this.add(func(), name);\n  }\n\n  WaitForMe(name: string | symbol = ''): MethodDecorator {\n    const get = this.get.bind(this);\n    const add = this.add.bind(this);\n    return function (\n      target: unknown,\n      key: string | symbol,\n      descriptor: PropertyDescriptor,\n    ): PropertyDescriptor {\n      const originalMethod = descriptor.value;\n      name = name || key;\n      descriptor.value = function (...args: any[]) {\n        const exist = get(name);\n        if (exist) {\n          return exist;\n        }\n        const result = add(originalMethod.apply(this, args), name);\n        return result;\n      };\n\n      return descriptor;\n    };\n  }\n\n  /** @deprecated use {@link PromiseControl.WaitForMe } instead */\n  GetOrCreateDecorator(name: string | symbol = ''): MethodDecorator {\n    return this.WaitForMe(name);\n  }\n\n  private _onStop(): void {\n    if (this.options.onStop && !this.isLoaded) {\n      this.options.onStop();\n    }\n  }\n}\n","export class TimeoutError extends Error {\n  name = 'TimeoutError';\n\n  constructor() {\n    super();\n    Object.setPrototypeOf(this, TimeoutError.prototype);\n  }\n}\n","import { CancelError } from './CancelError';\nimport { PromiseControl, PromiseControlOptions } from './PromiseControl';\nimport { TimeoutError } from './TimeoutError';\n\ntype Reject = (reason?: any) => void;\ntype Resolve = (value?: any) => void;\nexport type OnCancelFunction = (cancelHandler: () => void) => void;\n\nconst handleCallback = <T = never>(\n  resolve: Resolve,\n  reject: Reject,\n  callback: Resolve,\n  r: T,\n) => {\n  try {\n    resolve(callback(r));\n  } catch (e) {\n    reject(e);\n  }\n};\n\nlet ID = 0;\n\n/**\n * Promise that can be canceled\n *\n * @example\n * Catch `CancelError`\n * ```javascript\n * import CancelablePromise from \"@nextgis/cancelable-promise\";\n *\n * const promise = new CancelablePromise((resolve, reject) => {\n *  setTimeout(() => resolve(), 100);\n * }).catch((er) => {\n *  if (er.name === \"CancelError\") {\n *    // handle cancel error\n *  }\n *  throw er;\n * });\n *\n * promise.cancel();\n * ```\n * @example\n * Handle `onCancel` callback\n * ```javascript\n * import CancelablePromise from \"@nextgis/cancelable-promise\";\n *\n * const promise = new CancelablePromise((resolve, reject, onCancel) => {\n *   const xhr = new XMLHttpRequest();\n *   xhr.open(\"GET\", url, true);\n *   xhr.onload = () => {\n *     resolve(xhr.responseText);\n *   };\n *   xhr.onerror = (er) => {\n *     reject(er);\n *   };\n *\n *   onCancel(() => {\n *     xhr.abort();\n *   });\n *\n *   xhr.send();\n * });\n *\n * promise.cancel();\n * ```\n */\nexport class CancelablePromise<T = any> implements Promise<T> {\n  static CancelError = CancelError;\n  static TimeoutError = TimeoutError;\n  static PromiseControl = PromiseControl;\n\n  // @ts-ignore\n  readonly [Symbol.toStringTag]: string;\n  readonly id = ID++;\n  private _isCanceled = false;\n  private _isPending = true;\n  private _promise?: Promise<T>;\n  private _cancelPromise?: Promise<T>;\n  private _cancelHandlers: (() => void)[] = [];\n  private _setCanceledCallback?: (er?: any) => void;\n  private _parentPromise?: CancelablePromise;\n  private _children: CancelablePromise[] = [];\n\n  constructor(\n    executor: (\n      resolve: (value?: T | PromiseLike<T>) => void,\n      reject: (reason?: any) => void,\n      onCancel: OnCancelFunction,\n    ) => void,\n    timeout?: number,\n  ) {\n    this._cancelPromise = new Promise<any>((resolve_, reject_) => {\n      this._setCanceledCallback = (er) => resolve_(er || new CancelError());\n    });\n    const promises = [\n      this._cancelPromise,\n      new Promise<T>((resolve, reject) => {\n        const onResolve = (value?: T | PromiseLike<T>) => {\n          if (value instanceof CancelablePromise) {\n            this.attach(value);\n          } else {\n            this._isPending = false;\n          }\n          // TODO: fix types, `undefined` not allowed since 19.12.2020\n          resolve(value as T | PromiseLike<T>);\n        };\n\n        const onReject = (error: any) => {\n          this._isPending = false;\n          reject(error);\n        };\n\n        const onCancel: OnCancelFunction = (handler) => {\n          if (!this._isPending) {\n            throw new Error(\n              'The `onCancel` handler was attached after the promise settled.',\n            );\n          }\n\n          this._cancelHandlers.push(handler);\n        };\n\n        return executor(onResolve, onReject, onCancel);\n      }),\n    ];\n    if (timeout) {\n      promises.push(\n        new Promise((resolve, reject) => {\n          setTimeout(() => {\n            if (this._isPending) {\n              try {\n                this.cancel();\n              } finally {\n                reject(new TimeoutError());\n              }\n            }\n          }, timeout);\n        }),\n      );\n    }\n    this._promise = Promise.race(promises);\n  }\n\n  static createControl(opt?: PromiseControlOptions): PromiseControl {\n    return new PromiseControl(opt);\n  }\n\n  static resolve<T>(value: T | PromiseLike<T>): CancelablePromise<T> {\n    return new CancelablePromise((resolve) => resolve(value));\n  }\n\n  static reject<T>(value: T | PromiseLike<T>): CancelablePromise<T> {\n    return new CancelablePromise((resolve, reject) => reject(value));\n  }\n\n  static all<T>(values: (T | PromiseLike<T>)[]): CancelablePromise<T[]> {\n    return new CancelablePromise((resolve, reject) => {\n      Promise.all(values).then(resolve).catch(reject);\n    }).catch((er) => {\n      if (er instanceof this.CancelError) {\n        for (const v of values) {\n          const v_ = v as CancelablePromise\n          if ('cancel' in v_) {\n            v_.cancel();\n          }\n        }\n      }\n      throw er;\n    });\n  }\n\n  attach(p: CancelablePromise): void {\n    if (this._isCanceled) {\n      p.cancel();\n    } else {\n      this._children.push(p);\n    }\n  }\n\n  then<TResult1 = T, TResult2 = never>(\n    onfulfilled?:\n      | ((value: T) => TResult1 | PromiseLike<TResult1>)\n      | undefined\n      | null,\n    onrejected?:\n      | ((reason: any) => TResult2 | PromiseLike<TResult2>)\n      | undefined\n      | null,\n  ): CancelablePromise<TResult1 | TResult2> {\n    const p = new CancelablePromise((resolve, reject) => {\n      if (this._promise) {\n        const reject_ = (r: any) => {\n          if (onrejected) {\n            handleCallback(resolve, reject, onrejected, r);\n          } else {\n            reject(r);\n          }\n        };\n        this._promise.then((r) => {\n          if (this._isCanceled) {\n            reject_(r);\n          } else {\n            if (onfulfilled) {\n              handleCallback(resolve, reject, onfulfilled, r);\n            } else {\n              resolve(r);\n            }\n          }\n        }, reject_);\n      }\n    });\n    p._parentPromise = this;\n    this._children.push(p);\n    return p as CancelablePromise<TResult1 | TResult2>;\n  }\n\n  catch<TResult = never>(\n    onrejected?:\n      | ((reason: Error) => TResult | PromiseLike<TResult>)\n      | undefined\n      | null,\n  ): CancelablePromise<T | TResult> {\n    if (this._isCanceled && onrejected) {\n      onrejected(new CancelError());\n    }\n    return this.then(undefined, onrejected);\n  }\n\n  finally(onfinally?: (() => void) | undefined | null): Promise<T> {\n    if (this._promise) {\n      return this._promise.finally(onfinally);\n    }\n    if (this._isCanceled) {\n      return Promise.reject(new CancelError());\n    }\n    return Promise.reject<T>(onfinally);\n  }\n\n  cancel(): this {\n    // No reason to run cancel action if promise is already complete\n    if (this._isCanceled || !this._isPending) {\n      return this;\n    }\n    this._isCanceled = true;\n    const parent = this._getTopParent();\n    if (parent) {\n      parent.cancel();\n    }\n\n    if (this._children) {\n      this._children.forEach((x) => x.cancel());\n    }\n\n    if (this._isPending) {\n      if (this._cancelHandlers.length) {\n        try {\n          for (const handler of this._cancelHandlers) {\n            handler();\n          }\n        } catch (error) {\n          // this._setCanceledCallback(error);\n        }\n      }\n      if (this._setCanceledCallback) {\n        this._setCanceledCallback();\n      }\n    }\n    this._destroy();\n\n    return this;\n  }\n\n  private _getTopParent() {\n    let parent = this._parentPromise;\n    let hasParent = !!parent;\n    while (hasParent) {\n      if (parent && parent._parentPromise) {\n        parent = parent._parentPromise;\n        hasParent = !!parent;\n      } else {\n        hasParent = false;\n      }\n    }\n    return parent;\n  }\n\n  private _destroy() {\n    this._setCanceledCallback = undefined;\n    this._cancelPromise = undefined;\n    this._promise = undefined;\n  }\n}\n\nObject.setPrototypeOf(CancelablePromise.prototype, Promise.prototype);\n","/**\n * A promise you can stop\n *\n * @packageDocumentation\n * @module cancelable-promise\n */\nimport { CancelablePromise } from './CancelablePromise';\nimport { CancelError } from './CancelError';\n\nexport type { CancelError };\n\nexport default CancelablePromise;\n"],"names":["Cache","_options$namespace","options","arguments","length","undefined","_classCallCheck","_defineProperty","namespace","instance","this","key","value","cache","valueToSet","props","add","onlyFull","_this","exist","_find","Function","props_","JSON","parse","stringify","objectRemoveEmpty","cacheItem","full","push","Promise","catch","er","delete","then","x","cacheRecord","_this2","filter","_filter","map","keyOrItem","_this3","_step","_iterator","_createForOfIteratorHelper","s","n","done","e","index","indexOf","splice","err","f","_this4","find","item","itemProps","objectDeepEqual","CancelError","_Error","_inherits","_super","_assertThisInitialized","call","Object","setPrototypeOf","prototype","_wrapNativeSuper","Error","PromiseControl","Map","get","_promises","size","promise","has","_onStop","name","onStart","isLoaded","set","finally","remove","forEach","cancel","clear","func","bind","target","descriptor","originalMethod","_len","args","Array","_key","apply","WaitForMe","onStop","TimeoutError","handleCallback","resolve","reject","callback","r","ID","_Symbol$toStringTag","Symbol","toStringTag","CancelablePromise","executor","timeout","_cancelPromise","resolve_","reject_","_setCanceledCallback","promises","attach","_isPending","error","handler","_cancelHandlers","setTimeout","_promise","race","opt","values","all","_step2","_iterator2","v","p","_isCanceled","_children","onfulfilled","onrejected","_parentPromise","onfinally","parent","_getTopParent","_destroy","hasParent"],"sourceRoot":""}